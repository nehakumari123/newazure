$ErrorActionPreference = 'Stop' 2  3 # Deployment specific variables  4 $dnsName    = "abhinavinfytraining-vm2"  #new name 5 $saName     = "azureinfytrainingrg107" #change 6 $location   = "southeastasia"  #change 7  8 $cred = Get-Credential -Message "Enter Admin Credentials" 9  10 # Resource group values 11 $rgName     = "AzureInfyTraining-rg" #this will contain new VMs 12  13    14 $rgVNETName = "AzureInfyTraining-rg"  #this is RG of following VNET 15 $VNETName   = "AzureTrainingVNET" 16  17 # shyamal-VM2 specific variables  18 $pubName    = "MicrosoftWindowsServer" 19 $offerName  = "WindowsServer" 20 $skuName    = "2012-R2-Datacenter" 21 $ipName     = "abhinavinfyiip1" #NEW 22 $nicName    = "abhinavinfynic" #NEW 23 $vmName     = "abhinavinfyvm" #NEW 24 $vmSize     = "Standard_F1" #STANDARD_CAN_NOT_BE_CHANGED 25 $nsgName    = "AbhinavWebVMNSG" #OLD 26 $avSet      = "AbhinavWebAVSet" #OLD 27  28  29 Write-Host "Getting Existing Resources from resource group $rgName" -ForegroundColor Green 30  31 # Get the existing storage account   32 $storageAcc = Get-AzureRmStorageAccount -ResourceGroupName $rgName ` 33                                         -Name $saName 34  35 $blobEndpoint = $storageAcc.PrimaryEndpoints.Blob.ToString() 36  37 # Get the existing availability set 38 $avSet = Get-AzureRmAvailabilitySet -ResourceGroupName $rgName ` 39                                     -Name $avSet  40  41 # Get a reference to the existing virtual network  42 $vnet = Get-AzureRmVirtualNetwork -ResourceGroupName $rgVNETName ` 43                                   -Name $VNETName    44  45 # Get a reference to the existing network security group  46 $nsg = Get-AzureRmNetworkSecurityGroup -ResourceGroupName $rgName ` 47                                        -Name $nsgName 48  49 Write-Host "Creating new resources for VM $vmName" -ForegroundColor Green 50  51 # Create a new public IP address 52 $pip = New-AzureRmPublicIpAddress -Name $ipName ` 53                                 -ResourceGroupName $rgName ` 54                                 -Location $location ` 55                                 -AllocationMethod Dynamic ` 56                                 -DomainNameLabel $dnsName   57  58 # Create a new network interface in the Apps subnet .Subnets[0] 59 $nic = New-AzureRmNetworkInterface -Name $nicName ` 60                                  -ResourceGroupName $rgName ` 61                                  -Location $location ` 62                                  -SubnetId $vnet.Subnets[0].Id ` 63                                  -PublicIpAddressId $pip.Id ` 64                                  -NetworkSecurityGroupId $nsg.ID  65  66 # Create a new virtual machine configuration object 67 $vm = New-AzureRmVMConfig -VMName $vmName -VMSize $vmSize ` 68                           -AvailabilitySetId $avSet.Id 69  70 # Associate the network interface with the VM  71 Add-AzureRmVMNetworkInterface -Id $nic.Id -VM $vm 72  73  74 # Set the OS credentials 75 Set-AzureRmVMOperatingSystem -Windows ` 76                              -ComputerName $vmName ` 77                              -Credential $cred ` 78                              -ProvisionVMAgent ` 79                              -VM $vm 80  81 # Set the source image  82 Set-AzureRmVMSourceImage -PublisherName $pubName ` 83                          -Offer $offerName ` 84                          -Skus $skuName ` 85                          -Version "latest" ` 86                          -VM $vm 87  88 # Set the OS disk location  89 $osDiskName = "vm2-osdisk" 90 $osDiskUri    = $blobEndpoint + "vhds/" + $osDiskName  + ".vhd" 91  92 # Set the OS disk on the virtual machine configuration 93 Set-AzureRmVMOSDisk -Name $osDiskName ` 94                     -VhdUri $osDiskUri ` 95                     -CreateOption fromImage ` 96                     -VM $vm 97  98 Write-Host "Creating virtual machine $vmName" -ForegroundColor Green 99  100 # Create the virtual machine  101 New-AzureRmVM -ResourceGroupName $rgName -Location $location -VM $vm 102  103 # SQLVM-1 specific variables  104 $pubName    = "MicrosoftSQLServer" 105 $offerName  = "SQL2014SP1-WS2012R2" 106 $skuName    = "Web" 107 $nicName    = "sqlnic" #NEW 108 $vmName     = "infysqlvm" #NEW 109 $vmSize     = "Standard_A1" #STANDARD_CAN_NOT_BE_CHANGED 110  111  112 Write-Host "Creating new resources for VM $vmName" -ForegroundColor Green 113  114 # Create a new network interface in the Data subnet .Subnets[1].Id 115 $nic = New-AzureRmNetworkInterface -Name $nicName ` 116                                  -ResourceGroupName $rgName ` 117                                  -Location $location ` 118                                  -SubnetId $vnet.Subnets[1].Id  119  120 # Create a new virtual machine configuration object 121 $vm = New-AzureRmVMConfig -VMName $vmName -VMSize $vmSize  122  123 # Associate the network interface with the VM  124 Add-AzureRmVMNetworkInterface -Id $nic.Id -VM $vm 125  126 # Create the URI for data disk 1 127 $dataDiskName = "sqlvm1-datadisk1"  128 $dataDiskUri = $blobEndpoint + "vhds/" + $dataDiskName  + ".vhd" 129  130 # Attach data disk 1 to the VM configuration 131 Add-AzureRmVMDataDisk -Name $dataDiskName ` 132                       -VhdUri $dataDiskUri -Caching None ` 133                       -DiskSizeInGB 1023 -Lun 0 -CreateOption empty ` 134                       -VM $vm 135  136 # Create the URI for data disk 2 137 $dataDiskName = "sqlvm1-datadisk2"  138 $dataDiskUri = $blobEndpoint + "vhds/" + $dataDiskName  + ".vhd" 139  140 # Attach data disk 2 to the VM configuration  141 Add-AzureRmVMDataDisk -Name $dataDiskName ` 142                       -VhdUri $dataDiskUri -Caching None ` 143                       -DiskSizeInGB 1023 -Lun 1 -CreateOption empty ` 144                       -VM $vm 145  146  147 # Set the local administrative credentials  148 Set-AzureRmVMOperatingSystem -Windows ` 149                              -ComputerName $vmName ` 150                              -Credential $cred ` 151                              -ProvisionVMAgent  ` 152                              -VM $vm 153  154 # Set the source image  155 Set-AzureRmVMSourceImage -PublisherName $pubName ` 156                          -Offer $offerName ` 157                          -Skus $skuName ` 158                          -Version "latest" ` 159                          -VM $vm 160  161 # Create the URI to the OS disk of the SLQ server 162 $osDiskName = "sqlvm1-osdisk0" 163 $osDiskUri    = $blobEndpoint + "vhds/" + $osDiskName  + ".vhd" 164  165 # Set the OS disk on the VM configuration object 166 Set-AzureRmVMOSDisk -Name $osDiskName ` 167                     -VhdUri $osDiskUri ` 168                     -CreateOption fromImage ` 169                     -VM $vm 170  171 Write-Host "Creating virtual machine $vmName" -ForegroundColor Green 172  173  174 # Create the VM  175 New-AzureRmVM -ResourceGroupName $rgName ` 176                 -Location $location ` 177                 -VM $vm 
